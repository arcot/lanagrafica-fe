# This workflow will do a clean installation of node dependencies, build the source code and push to Docker Hub
# Implements semantic versioning based on branch patterns (release/** and feature/**)
# Based on LANagraficaFE CI workflow, adapted for Vite + runtime environment configuration

name: CI-CD workflow

on:
  push:
    branches:
      - 'main'
      - 'release/**'
      - 'feature/**'
  pull_request:
    branches:
      - 'main'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: 18

      - uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: Extract version from package.json
        id: version
        run: echo "VERSION=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT

      - name: Determine Docker tags
        id: tags
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          BRANCH_NAME=${GITHUB_REF#refs/heads/}

          if [[ "$BRANCH_NAME" == release/* ]]; then
            # Release branch: tag as VERSION and latest
            echo "TAGS=${VERSION},latest" >> $GITHUB_OUTPUT
            echo "Building release version: ${VERSION}"
          elif [[ "$BRANCH_NAME" == feature/* ]]; then
            # Feature branch: tag as VERSION-SNAPSHOT-feature-FEATURE_NAME
            FEATURE_NAME=$(echo "$BRANCH_NAME" | sed 's/feature\///')
            TAG="${VERSION}-SNAPSHOT-feature-${FEATURE_NAME}"
            echo "TAGS=${TAG}" >> $GITHUB_OUTPUT
            echo "Building feature version: ${TAG}"
          elif [[ "$BRANCH_NAME" == "main" ]]; then
            # Main branch: tag as VERSION-SNAPSHOT and latest
            echo "TAGS=${VERSION}-SNAPSHOT,latest" >> $GITHUB_OUTPUT
            echo "Building main version: ${VERSION}-SNAPSHOT"
          else
            # Other branches: tag as VERSION-dev
            echo "TAGS=${VERSION}-dev" >> $GITHUB_OUTPUT
            echo "Building dev version: ${VERSION}-dev"
          fi

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run TypeScript type check
        run: pnpm run typecheck

      - name: Run linting
        run: pnpm run lint

      - name: Build application
        run: pnpm run build

      - name: Build and push Docker image
        uses: mr-smithers-excellent/docker-build-push@v5
        with:
          image: arc0t/lanagrafica-fe
          registry: docker.io
          dockerfile: Dockerfile
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          tags: ${{ steps.tags.outputs.TAGS }}
