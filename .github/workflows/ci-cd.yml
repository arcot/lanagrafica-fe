# CI/CD Workflow for LANagrafica Frontend
# Features:
# - Automated semantic versioning based on conventional commits
# - Docker image build and push to Docker Hub
# - Support for release/** and feature/** branches
# - TypeScript type checking and linting

name: CI-CD

on:
  push:
    branches:
      - 'main'
      - 'release/**'
      - 'feature/**'
  pull_request:
    branches:
      - 'main'
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required for creating tags

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for proper versioning
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run TypeScript type check
        run: pnpm run typecheck

      - name: Run linting
        run: pnpm run lint

      - name: Build application
        run: pnpm run build

      - name: Determine version and Docker tags
        id: version
        run: |
          # Get current version from package.json
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "Current version: $CURRENT_VERSION"

          # Parse version components
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"

          # Get branch name
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          echo "Branch: $BRANCH_NAME"

          # Initialize version bump type
          BUMP_TYPE="none"

          # Analyze commits since last tag to determine version bump
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          if [ -z "$LAST_TAG" ]; then
            echo "No previous tags found, using current version from package.json"
            NEW_VERSION="$CURRENT_VERSION"
          else
            echo "Last tag: $LAST_TAG"

            # Get commits since last tag
            COMMITS=$(git log ${LAST_TAG}..HEAD --pretty=format:"%s" 2>/dev/null || git log --pretty=format:"%s")

            # Check for breaking changes (MAJOR version bump)
            if echo "$COMMITS" | grep -qiE "^(BREAKING CHANGE:|.*!:)"; then
              BUMP_TYPE="major"
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              echo "Found breaking changes - MAJOR version bump"
            # Check for new features (MINOR version bump)
            elif echo "$COMMITS" | grep -qiE "^feat(\(.+\))?:"; then
              BUMP_TYPE="minor"
              MINOR=$((MINOR + 1))
              PATCH=0
              echo "Found new features - MINOR version bump"
            # Check for fixes and other changes (PATCH version bump)
            elif echo "$COMMITS" | grep -qiE "^(fix|chore|docs|style|refactor|perf|test)(\(.+\))?:"; then
              BUMP_TYPE="patch"
              PATCH=$((PATCH + 1))
              echo "Found fixes/changes - PATCH version bump"
            else
              echo "No conventional commits found - using current version"
              BUMP_TYPE="none"
            fi

            NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
          fi

          echo "Version bump type: $BUMP_TYPE"
          echo "New version: $NEW_VERSION"

          # Determine Docker tags based on branch
          if [[ "$BRANCH_NAME" == release/* ]]; then
            # Release branch: use version and latest tags
            DOCKER_TAGS="${NEW_VERSION},latest"
            SHOULD_TAG_GIT="true"
            echo "Release branch - will create git tag v${NEW_VERSION}"
          elif [[ "$BRANCH_NAME" == feature/* ]]; then
            # Feature branch: use version with feature suffix
            FEATURE_NAME=$(echo "$BRANCH_NAME" | sed 's/feature\///' | sed 's/\//-/g')
            DOCKER_TAGS="${NEW_VERSION}-feature-${FEATURE_NAME}"
            SHOULD_TAG_GIT="false"
            echo "Feature branch - no git tag will be created"
          elif [[ "$BRANCH_NAME" == "main" ]]; then
            # Main branch: use version with dev suffix and latest
            DOCKER_TAGS="${NEW_VERSION}-dev,latest"
            SHOULD_TAG_GIT="false"
            echo "Main branch - no git tag will be created"
          else
            # Other branches: use version with branch suffix
            SAFE_BRANCH=$(echo "$BRANCH_NAME" | sed 's/\//-/g')
            DOCKER_TAGS="${NEW_VERSION}-${SAFE_BRANCH}"
            SHOULD_TAG_GIT="false"
          fi

          # Set outputs
          echo "version=${NEW_VERSION}" >> $GITHUB_OUTPUT
          echo "docker_tags=${DOCKER_TAGS}" >> $GITHUB_OUTPUT
          echo "should_tag=${SHOULD_TAG_GIT}" >> $GITHUB_OUTPUT
          echo "bump_type=${BUMP_TYPE}" >> $GITHUB_OUTPUT

          echo "Docker tags: $DOCKER_TAGS"

      - name: Update package.json version
        if: steps.version.outputs.should_tag == 'true' && steps.version.outputs.bump_type != 'none'
        run: |
          NEW_VERSION="${{ steps.version.outputs.version }}"
          npm version $NEW_VERSION --no-git-tag-version
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add package.json
          git commit -m "chore: bump version to $NEW_VERSION [skip ci]" || echo "No changes to commit"

      - name: Create and push git tag
        if: steps.version.outputs.should_tag == 'true' && steps.version.outputs.bump_type != 'none'
        run: |
          NEW_VERSION="${{ steps.version.outputs.version }}"
          git tag -a "v${NEW_VERSION}" -m "Release version ${NEW_VERSION}"
          git push origin "v${NEW_VERSION}"
          git push origin ${GITHUB_REF#refs/heads/}

      - name: Build and push Docker image
        uses: mr-smithers-excellent/docker-build-push@v5
        with:
          image: arc0t/lanagrafica-fe
          registry: docker.io
          dockerfile: Dockerfile
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          tags: ${{ steps.version.outputs.docker_tags }}

      - name: Summary
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version Bump**: ${{ steps.version.outputs.bump_type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Docker Tags**: ${{ steps.version.outputs.docker_tags }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${GITHUB_REF#refs/heads/}" >> $GITHUB_STEP_SUMMARY
          echo "- **Git Tag Created**: ${{ steps.version.outputs.should_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Semantic Versioning Rules" >> $GITHUB_STEP_SUMMARY
          echo "- **MAJOR** (X.0.0): Breaking changes (commit message contains \`BREAKING CHANGE:\` or \`!:\`)" >> $GITHUB_STEP_SUMMARY
          echo "- **MINOR** (x.Y.0): New features (commit message starts with \`feat:\`)" >> $GITHUB_STEP_SUMMARY
          echo "- **PATCH** (x.y.Z): Bug fixes and other changes (commit message starts with \`fix:\`, \`chore:\`, \`docs:\`, etc.)" >> $GITHUB_STEP_SUMMARY
